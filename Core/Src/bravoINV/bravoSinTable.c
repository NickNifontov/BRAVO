/*
 * bravoSinTable.c
 *
 *  Created on: Apr 4, 2020
 *      Author: Nick Nifontov
 */

#include "bravoSinTable.h"

// ****** Sin Table API ****** //
volatile uint8_t USE_SOFTSTART=1;
volatile float SoftStart_Coeff=SOFTSTART_START_COEF;
volatile uint8_t SoftStart_CNT=0;

volatile uint16_t SinInd=0;
volatile uint16_t Sin_Etalon[PULSE_IN_WAVE]={1, 27, 53, 80, 106, 132, 158, 185, 211, 237, 263, 289, 315, 342, 368, 394,
		420, 446, 472, 498, 524, 550, 576, 602, 628, 654, 680, 705, 731, 757, 783, 808, 834, 860, 885, 911, 936, 962,
		987, 1013, 1038, 1063, 1088, 1113, 1139, 1164, 1189, 1214, 1239, 1263, 1288, 1313, 1338, 1362, 1387, 1411, 1436,
		1460, 1484, 1509, 1533, 1557, 1581, 1605, 1629, 1653, 1676, 1700, 1723, 1747, 1770, 1794, 1817, 1840, 1863, 1886,
		1909, 1932, 1955, 1977, 2000, 2023, 2045, 2067, 2089, 2112, 2134, 2155, 2177, 2199, 2221, 2242, 2264, 2285, 2306,
		2327, 2348, 2369, 2390, 2411, 2431, 2452, 2472, 2492, 2512, 2532, 2552, 2572, 2592, 2611, 2631, 2650, 2669, 2688,
		2707, 2726, 2745, 2763, 2782, 2800, 2818, 2836, 2854, 2872, 2890, 2907, 2925, 2942, 2959, 2976, 2993, 3010, 3027,
		3043, 3059, 3076, 3092, 3108, 3123, 3139, 3155, 3170, 3185, 3200, 3215, 3230, 3245, 3259, 3273, 3288, 3302, 3316,
		3329, 3343, 3356, 3370, 3383, 3396, 3409, 3421, 3434, 3446, 3458, 3471, 3482, 3494, 3506, 3517, 3528, 3540, 3551,
		3561, 3572, 3582, 3593, 3603, 3613, 3623, 3632, 3642, 3651, 3660, 3669, 3678, 3687, 3695, 3704, 3712, 3720, 3728,
		3735, 3743, 3750, 3757, 3764, 3771, 3778, 3784, 3790, 3796, 3802, 3808, 3814, 3819, 3824, 3830, 3834, 3839, 3844,
		3848, 3852, 3856, 3860, 3864, 3867, 3871, 3874, 3877, 3880, 3882, 3885, 3887, 3889, 3891, 3893, 3895, 3896, 3897,
		3898, 3899, 3900, 3900, 3901, 3901, 3901, 3901, 3900, 3900, 3899, 3898, 3897, 3896, 3895, 3893, 3891, 3889, 3887,
		3885, 3882, 3880, 3877, 3874, 3871, 3867, 3864, 3860, 3856, 3852, 3848, 3844, 3839, 3834, 3830, 3824, 3819, 3814,
		3808, 3802, 3796, 3790, 3784, 3778, 3771, 3764, 3757, 3750, 3743, 3735, 3728, 3720, 3712, 3704, 3695, 3687, 3678,
		3669, 3660, 3651, 3642, 3632, 3623, 3613, 3603, 3593, 3582, 3572, 3561, 3551, 3540, 3528, 3517, 3506, 3494, 3482,
		3471, 3458, 3446, 3434, 3421, 3409, 3396, 3383, 3370, 3356, 3343, 3329, 3316, 3302, 3288, 3273, 3259, 3245, 3230,
		3215, 3200, 3185, 3170, 3155, 3139, 3123, 3108, 3092, 3076, 3059, 3043, 3027, 3010, 2993, 2976, 2959, 2942, 2925,
		2907, 2890, 2872, 2854, 2836, 2818, 2800, 2782, 2763, 2745, 2726, 2707, 2688, 2669, 2650, 2631, 2611, 2592, 2572,
		2552, 2532, 2512, 2492, 2472, 2452, 2431, 2411, 2390, 2369, 2348, 2327, 2306, 2285, 2264, 2242, 2221, 2199, 2177,
		2155, 2134, 2112, 2089, 2067, 2045, 2023, 2000, 1977, 1955, 1932, 1909, 1886, 1863, 1840, 1817, 1794, 1770, 1747,
		1723, 1700, 1676, 1653, 1629, 1605, 1581, 1557, 1533, 1509, 1484, 1460, 1436, 1411, 1387, 1362, 1338, 1313, 1288,
		1263, 1239, 1214, 1189, 1164, 1139, 1113, 1088, 1063, 1038, 1013, 987, 962, 936, 911, 885, 860, 834, 808, 783, 757,
		731, 705, 680, 654, 628, 602, 576, 550, 524, 498, 472, 446, 420, 394, 368, 342, 315, 289, 263, 237, 211, 185, 158,
		132, 106, 80, 53, 27};
// ******************************* //

void bravoSinTableRep(void) {
	if (SinInd>=PULSE_IN_WAVE) {
		SinInd=0;
	}

	if (USE_SOFTSTART==1) {
		LL_DAC_ConvertData12RightAligned(DAC1, LL_DAC_CHANNEL_1,(float)Sin_Etalon[SinInd]*(float)SoftStart_Coeff);
	} else {
		LL_DAC_ConvertData12RightAligned(DAC1, LL_DAC_CHANNEL_1, Sin_Etalon[SinInd]);
	}
	LL_DAC_TrigSWConversion(DAC1, LL_DAC_CHANNEL_1);

	// Current DAC in death zone
	LL_DAC_ConvertData12RightAligned(DAC2, LL_DAC_CHANNEL_1, DAC_CUR_RETRIG_LEVEL);
	LL_DAC_TrigSWConversion(DAC2, LL_DAC_CHANNEL_1);

	SinInd++;
}

void bravoRetrigVDac(void) {
	if (USE_SOFTSTART==1) {
		LL_DAC_ConvertData12RightAligned(DAC1, LL_DAC_CHANNEL_1, (float)Sin_Etalon[SinInd]*(float)SoftStart_Coeff+RetrigVDac_Delta);
	} else {
		LL_DAC_ConvertData12RightAligned(DAC1, LL_DAC_CHANNEL_1, Sin_Etalon[SinInd]+RetrigVDac_Delta);
	}
	LL_DAC_TrigSWConversion(DAC1, LL_DAC_CHANNEL_1);

	// Current DAC in death zone
	LL_DAC_ConvertData12RightAligned(DAC2, LL_DAC_CHANNEL_1, DAC_CUR_RETRIG_LEVEL);
	LL_DAC_TrigSWConversion(DAC2, LL_DAC_CHANNEL_1);

}

void bravoRestoreIDac(void) {
	LL_DAC_ConvertData12RightAligned(DAC2, LL_DAC_CHANNEL_1, DAC_CUR_LEVEL);
	LL_DAC_TrigSWConversion(DAC2, LL_DAC_CHANNEL_1);
}

